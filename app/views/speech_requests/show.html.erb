<h1 class="page-title">Generated Celebrant Speech</h1>

<div class="speech-details">
  <p><strong>Name:</strong> <%= @speech_request.name %></p>
  <p><strong>Relation:</strong> <%= @speech_request.relation %></p>
</div>

<hr class="divider">

<h2 class="speech-title">Your Celebrant Speech</h2>

<div id="speech-content">
  <p>Loading your speech...</p>
</div>

<!-- Audio Controls -->
<button type="button" onclick="readAloud()">üîä Play</button>
<button type="button" onclick="pauseSpeech()">‚è∏Ô∏è Pause</button>
<button type="button" onclick="resumeSpeech()">‚ñ∂Ô∏è Resume</button>
<button type="button" onclick="stopSpeech()">‚èπÔ∏è Stop</button>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const speechContent = document.getElementById("speech-content");
    const speechRequestId = "<%= @speech_request.id %>";
    let utterance;  // Declare globally to control state

    if (!window.speechPolling) {
      function checkSpeechStatus() {
        fetch(`/speech_requests/${speechRequestId}/check_status`)
          .then(response => response.json())
          .then(data => {
            if (data.generated_speech) {
              speechContent.innerHTML = `<p>${data.generated_speech}</p>`;
              clearInterval(window.speechPolling);  // Stop polling when speech is ready
            }
          })
          .catch(error => console.error("Error:", error));
      }

      window.speechPolling = setInterval(checkSpeechStatus, 5000);
    }
  });

  function readAloud() {
    const content = document.getElementById("speech-content").textContent;
    if (content && content.trim() !== "Loading your speech...") {
      stopSpeech();  // Stop any ongoing speech before starting new one
      utterance = new SpeechSynthesisUtterance(content);
      window.speechSynthesis.speak(utterance);
    } else {
      alert("The speech is not ready yet.");
    }
  }

  function pauseSpeech() {
    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
      window.speechSynthesis.pause();
    }
  }

  function resumeSpeech() {
    if (window.speechSynthesis.paused) {
      window.speechSynthesis.resume();
    }
  }

  function stopSpeech() {
    window.speechSynthesis.cancel();  // Stops the speech synthesis completely
  }
</script>

<%= link_to 'Create another speech', new_speech_request_path, class: "new-speech-link" %>
